import{b as Q,r,m as p,j as e,S as j,g as N}from"./index-mbJjgMST.js";import{D as W}from"./DashboardLayout-B1KlLbJt.js";import{A as X}from"./AdminLayout-CGz82RL4.js";const Z=3e3,O=c=>{const f=new Date,m=new Date(c),i=Math.floor((f-m)/1e3);return i<10?"just now":i<60?`${i}s ago`:i<3600?`${Math.floor(i/60)}m ago`:i<86400?`${Math.floor(i/3600)}h ago`:i<604800?`${Math.floor(i/86400)}d ago`:m.toLocaleDateString()},ae=()=>{const{user:c}=Q(),f=c?.role==="admin",m=f?X:W,i=f?{}:{pageTitle:"Student Doubts",role:"mentor"},[d,P]=r.useState([]),[Y,C]=r.useState(!0),[s,x]=r.useState(null),[w,h]=r.useState([]),[u,y]=r.useState(""),[_,T]=r.useState(!1),[k,q]=r.useState("all"),[b,A]=r.useState(!1),[K,V]=r.useState(!1),$=r.useRef(null),v=r.useRef(null),B=r.useRef(null),S=r.useRef(null),M=r.useRef(null);r.useEffect(()=>{M.current=s},[s]);const g=r.useCallback((t=!0)=>{$.current?.scrollIntoView({behavior:t?"smooth":"instant"})},[]),z=r.useCallback(()=>{const t=v.current;if(!t)return;const a=t.scrollHeight-t.scrollTop-t.clientHeight<80;V(!a)},[]),R=async()=>{C(!0);const t=await p.getDoubts();t.success&&P(t.doubts||[]),C(!1)};r.useEffect(()=>{R()},[]);const D=r.useCallback(async()=>{const t=M.current;if(t)try{const a=await p.getDoubt(t.id);if(a.success){const l=a.replies||[];h(o=>{if(l.length!==o.length||JSON.stringify(l.map(n=>n.id))!==JSON.stringify(o.map(n=>n.id))){const n=v.current;return(!n||n.scrollHeight-n.scrollTop-n.clientHeight<80)&&setTimeout(()=>g(),50),l}return o}),a.doubt&&x(a.doubt)}}catch{}},[g]);r.useEffect(()=>(s&&(S.current=setInterval(D,Z)),()=>{S.current&&clearInterval(S.current)}),[s?.id,D]);const F=async t=>{T(!0),x(t),h([]),y("");const a=await p.getDoubt(t.id);a.success&&(x(a.doubt),h(a.replies||[]),setTimeout(()=>g(!1),100)),T(!1)},E=async()=>{if(!u.trim()||!s||b)return;const t=u.trim();y(""),A(!0);const a=!s.assignedMentorId,l={id:`temp-${Date.now()}`,authorName:c?.fullName||"You",authorRole:c?.role||"mentor",content:t,createdAt:new Date().toISOString(),_sending:!0};h(n=>[...n,l]),setTimeout(()=>g(),50);const o=await p.replyDoubt(s.id,{content:t});A(!1),o.success?(a&&j.fire({...N(),icon:"success",title:"You are now assigned!",text:"This doubt has been assigned to you.",timer:2500,showConfirmButton:!1}),D(),R()):(h(n=>n.filter(H=>H.id!==l.id)),y(t)),B.current?.focus()},J=t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),E())},G=async()=>{if((await j.fire({...N(),title:"Resolve Doubt?",text:"Mark this doubt as resolved?",icon:"question",showCancelButton:!0,confirmButtonColor:"#16a34a",confirmButtonText:"Yes, Resolve"})).isConfirmed){const a=await p.resolveDoubt(s.id);a.success?(j.fire({...N(),icon:"success",title:"Resolved!",timer:1500,showConfirmButton:!1}),x(l=>({...l,status:"resolved"})),R()):j.fire({...N(),icon:"error",title:"Error",text:a.message||"Could not resolve. You may not be assigned to this doubt."})}},I=t=>({open:"bg-amber-100 text-amber-800 dark-theme:bg-amber-900/30 dark-theme:text-amber-300","in-progress":"bg-blue-100 text-blue-800 dark-theme:bg-blue-900/30 dark-theme:text-blue-300",resolved:"bg-green-100 text-green-800 dark-theme:bg-green-900/30 dark-theme:text-green-300",closed:"bg-gray-100 text-gray-800 dark-theme:bg-gray-700 dark-theme:text-gray-300"})[t]||"bg-gray-100 text-gray-800",L=t=>({high:"text-red-500",medium:"text-amber-500",low:"text-green-500"})[t]||"text-gray-500",U=k==="all"?d:d.filter(t=>t.status===k);return s?e.jsxs(m,{...i,children:[e.jsx("style",{children:`
          @keyframes msgSlideIn {
            from { opacity: 0; transform: translateY(12px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
          }
          .chat-msg { animation: msgSlideIn 0.25s ease-out both; }
          .chat-msg-sending { opacity: 0.7; }
          @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
          }
          .live-dot { animation: livePulse 2s infinite; }
        `}),e.jsxs("div",{className:"max-w-4xl mx-auto flex flex-col",style:{height:"calc(100vh - 7rem)"},children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsxs("button",{onClick:()=>x(null),className:"flex items-center gap-2 text-primary hover:text-primary-dark font-medium transition",children:[e.jsx("i",{className:"ri-arrow-left-line text-lg"})," Back"]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2 text-xs text-gray-400 dark-theme:text-gray-500",children:[e.jsx("span",{className:"live-dot inline-block w-2 h-2 rounded-full bg-green-500"}),"Live"]})]}),_?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("div",{className:"flex items-center justify-center py-10",children:e.jsx("i",{className:"ri-loader-4-line animate-spin text-2xl text-primary"})})}):e.jsxs("div",{className:"flex-1 flex flex-col bg-white dark-theme:bg-gray-800 rounded-xl shadow-lg overflow-hidden min-h-0",children:[e.jsxs("div",{className:"px-5 py-4 border-b dark-theme:border-gray-700 bg-white/80 dark-theme:bg-gray-800/80 backdrop-blur-sm flex-shrink-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 dark-theme:text-gray-100 truncate",children:s.title}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-xs text-gray-500 dark-theme:text-gray-400 flex-wrap",children:[e.jsxs("span",{children:[e.jsx("i",{className:"ri-user-line mr-1"}),s.studentName]}),s.studentEmail&&e.jsx("span",{className:"text-gray-400",children:s.studentEmail}),s.courseTitle&&e.jsxs("span",{className:"text-primary",children:[e.jsx("i",{className:"ri-book-open-line mr-1"}),s.courseTitle]}),e.jsxs("span",{children:[e.jsx("i",{className:"ri-time-line mr-1"}),O(s.createdAt)]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-semibold ${I(s.status)}`,children:s.status}),e.jsx("span",{className:L(s.priority),children:e.jsx("i",{className:"ri-flag-fill"})})]})]}),s.description&&e.jsx("p",{className:"mt-2 text-sm text-gray-500 dark-theme:text-gray-400 line-clamp-2",children:s.description}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs flex-wrap",children:[s.mentorName&&e.jsxs("span",{className:"bg-blue-50 dark-theme:bg-blue-900/20 text-blue-700 dark-theme:text-blue-300 px-2 py-0.5 rounded font-medium",children:[e.jsx("i",{className:"ri-user-star-line mr-1"}),"Assigned: ",s.mentorName]}),!s.assignedMentorId&&e.jsxs("span",{className:"bg-amber-50 dark-theme:bg-amber-900/20 text-amber-700 dark-theme:text-amber-300 px-2 py-0.5 rounded font-medium animate-pulse",children:[e.jsx("i",{className:"ri-alert-line mr-1"}),"Unassigned — reply to claim"]})]})]}),e.jsxs("div",{ref:v,onScroll:z,className:"flex-1 overflow-y-auto px-5 py-4 space-y-3 relative",style:{scrollBehavior:"smooth"},children:[w.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400 dark-theme:text-gray-500",children:[e.jsx("i",{className:"ri-chat-smile-3-line text-5xl mb-3 opacity-40"}),e.jsx("p",{className:"text-sm font-medium",children:"No replies yet"}),e.jsx("p",{className:"text-xs mt-1",children:"Be the first to respond — your reply will appear here live"})]}):e.jsx(e.Fragment,{children:w.map((t,a)=>{const l=t.authorRole==="student",o=a===0||w[a-1]?.authorRole!==t.authorRole;return e.jsxs("div",{className:`flex ${l?"justify-start":"justify-end"} chat-msg ${t._sending?"chat-msg-sending":""}`,style:{animationDelay:`${Math.min(a*.03,.3)}s`},children:[l&&e.jsx("div",{className:"flex-shrink-0 mr-2 mt-auto",children:o?e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-white text-xs font-bold shadow-sm",children:t.authorName?.charAt(0)?.toUpperCase()||"S"}):e.jsx("div",{className:"w-8"})}),e.jsxs("div",{className:`max-w-[75%] ${l?"":"order-1"}`,children:[o&&e.jsxs("p",{className:`text-xs font-medium mb-1 ${l?"text-gray-500 dark-theme:text-gray-400":"text-right text-primary/70"}`,children:[t.authorName,t.authorRole==="student"&&" · Student",t.authorRole==="mentor"&&" · Mentor",t.authorRole==="admin"&&" · Admin"]}),e.jsx("div",{className:`rounded-2xl px-4 py-2.5 shadow-sm ${l?"bg-gray-100 dark-theme:bg-gray-700 text-gray-900 dark-theme:text-gray-100 rounded-bl-md":"bg-primary text-white rounded-br-md"}`,children:e.jsx("p",{className:"text-sm whitespace-pre-wrap leading-relaxed",children:t.content})}),e.jsx("p",{className:`text-[10px] mt-1 ${l?"":"text-right"} text-gray-400 dark-theme:text-gray-500`,children:t._sending?e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx("i",{className:"ri-time-line"})," Sending..."]}):O(t.createdAt)})]}),!l&&e.jsx("div",{className:"flex-shrink-0 ml-2 mt-auto",children:o?e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-primary to-pink-500 flex items-center justify-center text-white text-xs font-bold shadow-sm",children:c?.fullName?.charAt(0)?.toUpperCase()||"M"}):e.jsx("div",{className:"w-8"})})]},t.id)})}),e.jsx("div",{ref:$})]}),K&&e.jsx("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 z-10",children:e.jsxs("button",{onClick:()=>g(),className:"bg-primary text-white rounded-full px-4 py-1.5 text-xs shadow-lg hover:bg-primary-dark transition flex items-center gap-1",children:[e.jsx("i",{className:"ri-arrow-down-line"})," New messages"]})}),s.status!=="resolved"&&s.status!=="closed"?e.jsxs("div",{className:"px-4 py-3 border-t dark-theme:border-gray-700 bg-white/80 dark-theme:bg-gray-800/80 backdrop-blur-sm flex-shrink-0",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("textarea",{ref:B,value:u,onChange:t=>y(t.target.value),onKeyDown:J,placeholder:s.assignedMentorId?"Type a message...":"Reply to claim this doubt...",rows:1,className:"flex-1 px-4 py-2.5 border rounded-2xl dark-theme:bg-gray-700 dark-theme:border-gray-600 dark-theme:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent resize-none text-sm max-h-32 overflow-y-auto",style:{minHeight:"42px"},onInput:t=>{t.target.style.height="auto",t.target.style.height=Math.min(t.target.scrollHeight,128)+"px"}}),e.jsx("button",{onClick:E,disabled:!u.trim()||b,className:`p-2.5 rounded-full transition shadow-sm flex-shrink-0 ${u.trim()&&!b?"bg-primary text-white hover:bg-primary-dark hover:shadow-md":"bg-gray-200 dark-theme:bg-gray-700 text-gray-400 cursor-not-allowed"}`,children:b?e.jsx("i",{className:"ri-loader-4-line animate-spin text-lg"}):e.jsx("i",{className:"ri-send-plane-2-fill text-lg"})}),s.status==="in-progress"&&e.jsxs("button",{onClick:G,className:"px-3 py-2.5 bg-green-600 text-white rounded-full hover:bg-green-700 transition font-medium text-sm flex-shrink-0",children:[e.jsx("i",{className:"ri-check-double-line mr-1"}),"Resolve"]})]}),e.jsx("p",{className:"text-[10px] text-gray-400 dark-theme:text-gray-500 mt-1.5 text-center",children:"Press Enter to send · Shift+Enter for new line"})]}):e.jsxs("div",{className:"px-4 py-3 border-t dark-theme:border-gray-700 text-center text-sm text-gray-400 dark-theme:text-gray-500 bg-gray-50 dark-theme:bg-gray-900/30",children:[e.jsx("i",{className:"ri-check-double-line mr-1"})," This conversation has been ",s.status]})]})]})]}):e.jsx(m,{...i,children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark-theme:text-gray-100",children:"Student Doubts"}),e.jsx("p",{className:"text-gray-500 dark-theme:text-gray-400 text-sm mt-1",children:"Answer student questions — first mentor to reply gets auto-assigned"})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white dark-theme:bg-gray-800 rounded-xl p-4 shadow-sm",children:[e.jsx("p",{className:"text-2xl font-bold text-amber-600",children:d.filter(t=>t.status==="open").length}),e.jsx("p",{className:"text-sm text-gray-500 dark-theme:text-gray-400",children:"Open (Unassigned)"})]}),e.jsxs("div",{className:"bg-white dark-theme:bg-gray-800 rounded-xl p-4 shadow-sm",children:[e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:d.filter(t=>t.status==="in-progress").length}),e.jsx("p",{className:"text-sm text-gray-500 dark-theme:text-gray-400",children:"In Progress"})]}),e.jsxs("div",{className:"bg-white dark-theme:bg-gray-800 rounded-xl p-4 shadow-sm",children:[e.jsx("p",{className:"text-2xl font-bold text-green-600",children:d.filter(t=>t.status==="resolved").length}),e.jsx("p",{className:"text-sm text-gray-500 dark-theme:text-gray-400",children:"Resolved"})]}),e.jsxs("div",{className:"bg-white dark-theme:bg-gray-800 rounded-xl p-4 shadow-sm",children:[e.jsx("p",{className:"text-2xl font-bold text-primary",children:d.length}),e.jsx("p",{className:"text-sm text-gray-500 dark-theme:text-gray-400",children:"Total Visible"})]})]}),e.jsx("div",{className:"flex gap-2 mb-6 overflow-x-auto pb-2",children:["all","open","in-progress","resolved"].map(t=>e.jsxs("button",{onClick:()=>q(t),className:`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition ${k===t?"bg-primary text-white shadow":"bg-white dark-theme:bg-gray-800 text-gray-600 dark-theme:text-gray-300 hover:bg-gray-50 dark-theme:hover:bg-gray-700 border dark-theme:border-gray-700"}`,children:[t==="all"?"All":t.charAt(0).toUpperCase()+t.slice(1)," ","(",t==="all"?d.length:d.filter(a=>a.status===t).length,")"]},t))}),Y?e.jsx("div",{className:"flex items-center justify-center py-10",children:e.jsx("i",{className:"ri-loader-4-line animate-spin text-2xl text-primary"})}):U.length===0?e.jsxs("div",{className:"text-center py-16 bg-white dark-theme:bg-gray-800 rounded-xl",children:[e.jsx("i",{className:"ri-question-answer-line text-5xl text-gray-300 dark-theme:text-gray-600 mb-3 block"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-600 dark-theme:text-gray-400",children:"No doubts found"}),e.jsx("p",{className:"text-gray-400 dark-theme:text-gray-500 text-sm mt-1",children:"Student doubts will appear here when posted"})]}):e.jsx("div",{className:"space-y-3",children:U.map(t=>e.jsx("div",{onClick:()=>F(t),className:"bg-white dark-theme:bg-gray-800 rounded-xl p-5 shadow-sm hover:shadow-md transition cursor-pointer border border-transparent hover:border-primary/20 dark-theme:hover:border-purple-800 group",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-1 flex-wrap",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark-theme:text-gray-100 truncate group-hover:text-primary transition",children:t.title}),e.jsx("span",{className:L(t.priority),children:e.jsx("i",{className:"ri-flag-fill text-sm"})}),!t.assignedMentorId&&e.jsx("span",{className:"bg-amber-100 dark-theme:bg-amber-900/30 text-amber-600 dark-theme:text-amber-400 text-xs px-2 py-0.5 rounded-full font-medium",children:"Unassigned"})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-500 dark-theme:text-gray-400 flex-wrap",children:[e.jsxs("span",{children:[e.jsx("i",{className:"ri-user-line mr-1"}),t.studentName]}),t.courseTitle&&e.jsxs("span",{children:[e.jsx("i",{className:"ri-book-open-line mr-1"}),t.courseTitle]}),e.jsxs("span",{children:[e.jsx("i",{className:"ri-chat-3-line mr-1"}),t.replyCount||0," replies"]}),e.jsxs("span",{children:[e.jsx("i",{className:"ri-time-line mr-1"}),new Date(t.createdAt).toLocaleDateString()]})]})]}),e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-semibold whitespace-nowrap ${I(t.status)}`,children:t.status})]})},t.id))})]})})};export{ae as default};
